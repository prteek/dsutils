#!/usr/bin/env python3

import sys
import pandas as pd
import numpy as np
from scipy import stats
import statsmodels.api as sm
from plotnine import *
import io

def main():
    # Read CSV data from stdin
    df = pd.read_csv(sys.stdin)

    # Get the operation string from command-line arguments
    if len(sys.argv) < 2:
        print("Error: No operation string provided", file=sys.stderr)
        sys.exit(1)

    operation = sys.argv[1]

    try:
        # Execute the operation string
        result = eval(operation)

        # Check if the result is a DataFrame
        if isinstance(result, pd.DataFrame):
            result.to_csv(sys.stdout, index=False)
        elif isinstance(result, ggplot):
            # Save the plot to a buffer
            buffer = io.BytesIO()
            result.save(buffer, format='png')
            buffer.seek(0)
            sys.stdout.buffer.write(buffer.getvalue())
            buffer.close()
        else:
            # If it's not a DataFrame, print the result directly
            print(result)

    except Exception as e:
        print(f"Error during operation: {e}", file=sys.stderr)
        sys.exit(1)

if __name__ == "__main__":
    main()